name: Build → Test → Docker → Deploy → Smoke Test

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ci-cd:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ==========================================================
      # BACKEND BUILD & TEST
      # ==========================================================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build Backend & Run Tests
        working-directory: backend
        run: mvn -B clean verify

      # ==========================================================
      # FRONTEND BUILD & TEST
      # ==========================================================
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm install

      - name: Run Frontend Tests
        working-directory: frontend
        run: npm test -- --watch=false --passWithNoTests
        continue-on-error: true

      # ==========================================================
      # DOCKER BUILD & PUSH (GHCR)
      # ==========================================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Set lowercase repo owner
        run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Build Backend Docker Image
        run: docker build -t ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }} backend

      - name: Build Frontend Docker Image
        run: docker build -t ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }} frontend

      - name: Push Docker Images
        run: |
          docker push ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }}
          docker push ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }}

      # ==========================================================
      # AWS DEPLOYMENT
      # ==========================================================
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get EC2 Instance
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=app-server" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].InstanceId" \
            --output text | head -n1)

          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT

      - name: Deploy via SSM
        if: ${{ steps.ec2.outputs.instance_id != '' }}
        run: |
          aws ssm send-command \
            --instance-ids "${{ steps.ec2.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy CI build" \
            --parameters "commands=[
              \"GHCR_USER=${{ github.repository_owner }} \
               GHCR_TOKEN=${{ secrets.GHCR_PAT }} \
               DB_HOST=localhost \
               DB_USER=attendance_user \
               DB_PASS=${{ secrets.DB_MASTER_PASSWORD }} \
               BACKEND_IMAGE=ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }} \
               FRONTEND_IMAGE=ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }} \
               /opt/app/deploy.sh\" 
            ]"

      # ==========================================================
      # SMART SMOKE TESTS
      # ==========================================================
      - name: Wait for Backend Health
        run: |
          for i in {1..20}; do
            if curl -s http://${{ steps.ec2.outputs.public_ip }}:8080/actuator/health | grep '"status":"UP"'; then
              echo "Backend is UP"
              exit 0
            fi
            echo "Waiting for backend..."
            sleep 10
          done
          echo "Backend failed to start"
          exit 1

      - name: Frontend Smoke Test
        run: |
          curl -f http://${{ steps.ec2.outputs.public_ip }}
